name: Build Windows

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set up Odin
        uses: laytan/setup-odin@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Assimp
        shell: pwsh
        run: |
          vcpkg install assimp:x64-windows
          $lib = Get-ChildItem C:\vcpkg\installed\x64-windows\lib\assimp*.lib | Select-Object -First 1
          Copy-Item $lib.FullName src\vendor\assimp\assimp-vc140-mt.lib

      - name: Build Sokol
        shell: cmd
        working-directory: src/vendor/sokol/sokol
        run: build_clibs_windows.cmd

      - name: Download sokol-shdc
        shell: pwsh
        run: |
          Invoke-WebRequest `
            https://github.com/floooh/sokol-tools-bin/raw/master/bin/win32/sokol-shdc.exe `
            -OutFile bin\sokol-shdc.exe

      - name: Compile shaders
        shell: pwsh
        run: |
          Get-ChildItem src\shaders\*.glsl | ForEach-Object {
            $name = $_.BaseName
            .\bin\sokol-shdc.exe `
              --input $_.FullName `
              --output "src\shaders\generated_${name}.odin" `
              --slang hlsl5:glsl430:glsl300es `
              --format sokol_odin
          }

      - name: Build
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force target | Out-Null
          odin build src -out=target\game.exe -debug

      - name: Copy runtime DLLs
        shell: pwsh
        run: |
          Get-ChildItem C:\vcpkg\installed\x64-windows\bin\assimp*.dll |
            Copy-Item -Destination target\

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-windows
          path: target\
